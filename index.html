<script>
  const { sdk } = window.FarcasterMiniApp || { sdk: { actions: { ready: () => {} } } };
  const { createPublicClient, createWalletClient, custom, http } = window.viem;
  const { baseSepolia } = window.viem.chains;

  const coin = document.getElementById("coin");
  const resultEl = document.getElementById("result");
  const connectBtn = document.getElementById("connectBtn");
  const tossBtn = document.getElementById("tossBtn");
  const statusEl = document.getElementById("status");

  const publicClient = createPublicClient({
    chain: baseSepolia,
    transport: http()
  });

  let walletClient = null;

  // ğŸ”¹ Chá» MetaMask inject
  async function waitForEthereum() {
    return new Promise((resolve) => {
      if (window.ethereum) return resolve(window.ethereum);
      const check = setInterval(() => {
        if (window.ethereum) {
          clearInterval(check);
          resolve(window.ethereum);
        }
      }, 200);
    });
  }

  async function connectWallet() {
    const ethereum = await waitForEthereum();

    if (!ethereum) {
      statusEl.textContent = "âš ï¸ KhÃ´ng phÃ¡t hiá»‡n vÃ­. HÃ£y cÃ i MetaMask!";
      return;
    }

    try {
      await ethereum.request({ method: "eth_requestAccounts" });
      const accounts = await ethereum.request({ method: "eth_accounts" });
      walletClient = createWalletClient({
        account: accounts[0],
        chain: baseSepolia,
        transport: custom(ethereum)
      });
      statusEl.textContent = `âœ… ÄÃ£ káº¿t ná»‘i: ${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}`;
    } catch (err) {
      console.error(err);
      statusEl.textContent = "âŒ Káº¿t ná»‘i vÃ­ tháº¥t báº¡i.";
    }
  }

  connectBtn.addEventListener("click", connectWallet);

  tossBtn.addEventListener("click", async () => {
    resultEl.textContent = "";
    coin.style.transform = "rotateY(0deg)";
    coin.style.transition = "transform 1s ease-in-out";
    coin.style.transform = "rotateY(3600deg)";

    setTimeout(async () => {
      const outcomes = ["Sáº¥p ğŸª™", "Ngá»­a ğŸª™"];
      const result = outcomes[Math.floor(Math.random() * outcomes.length)];
      resultEl.textContent = result;

      if (walletClient) {
        try {
          statusEl.textContent = "â³ Gá»­i transaction lÃªn Base...";
          const tx = await walletClient.sendTransaction({
            to: walletClient.account.address,
            value: 0n
          });
          statusEl.innerHTML = `âœ… Tx thÃ nh cÃ´ng: <a href="https://sepolia.basescan.org/tx/${tx}" target="_blank">${tx.slice(0,10)}...</a>`;
        } catch (err) {
          console.error(err);
          statusEl.textContent = "âŒ Gá»­i transaction tháº¥t báº¡i.";
        }
      } else {
        statusEl.textContent = "âš ï¸ ChÆ°a káº¿t ná»‘i vÃ­!";
      }

      sdk.actions.ready();
    }, 1000);
  });
</script>
